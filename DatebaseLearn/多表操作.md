# MySQL

## MySQL多表操作

### 1、基本介绍

​	实际开发中，一个项目通常需要很多张表才能完成。例如，一个商品项目就需要分类表(category)、商品表(products)、订单表(orders)等多张表。且这些表的数据之间存在一定的关系，接下来我们将在单表的基础上，一起学习多表方面的知识。

### 2、多表关系

​	MySQL多表之间的关系可以概括为：一对一、一对多/多对一关系，多对多

- 一对一关系
  - 一个学生只有一张身份张；一张身份证只能对应一个学生。
  - 在任一表中添加唯一外键，指向另一方主键，确保一对一关系。
  - 一般一对一关系很少见，遇到一对一关系的表最好是合并表。
- 一对多/多对一关系
  部门和员工
  分析：一个部门有多个员工，一个员工只能对应一个部门
  实现原则：在多的一方建立外键，指向一的一方的主键
- 多对多关系
  学生和课程
  分析：一个学生可以选择很多门课程，一个课程也可以被很多学生选择
  原则：多对多关系实现需要借助第三张中间表。中间表至少包含两个字段，将多对多的关系，拆成一对多的关系，中间表至少要有两个外键，这两个外键分别指向原来的那两张表的主键。

### 3、外键约束

- 介绍
  MySQL外键约束（FOREIGN KEY）时表的一个特殊字段，经常与主键约束一起使用。对于两个具有关联关系的表而言，相关联字段中主键所在的表就是主表（父表），外键所在的表就是从表（子表）。
  外键用来建立主表与从表的关联关系，为两个表的数据建立连接，约束两个表中数据的一致性和完整性。比如，一个水果摊，只有苹果、桃子、李子、西瓜四种水果，那么你来到水果摊要买水果就只能选择苹果、桃子、李子和西瓜，其他的水果都是不能购买的。

- 特点
  定义一个外键时，需要遵守下列规则：

  - 主表必须已经存在于数据库中，或者是当前正在创建的表。
  - 必须为主表定义主键。
  - 主键不能包含空值，但允许在外键中出现空值。也就是说，只要外键的每个非空值出现在指定的主键中，这个外键的内容就是正确的。
  - 在主表的表名后面指定列名或列名的组合。这个列或列的组合必须是主表的主键或候选键。
  - 外键中列的数目必须和主表的主键中列的数目相同。
  - 外键中列的数据必须和主表主键中对应列的数据类型相同。

- 操作
  创建外键约束：

  - 方式1-在创建表时设置外键约束
    在create table语句中，通过foreign key关键字来指定外键，具体的语法格式如下：
    ![image-20240119143215723](photo/image-20240119143215723.png)实现：

    ```sql
    -- 方式1-在创建表时设置外键约束
    -- 创建部门表
    CREATE TABLE IF NOT EXISTS dept(
    	deptno VARCHAR(20) PRIMARY KEY,	-- 部门号
    	name VARCHAR(20)	-- 部门名字
    );
    -- 创建员工表
    CREATE TABLE IF NOT EXISTS emp(
    	eid VARCHAR(20) PRIMARY KEY,
    	ename VARCHAR(20),
    	age INT,
    	dept_id VARCHAR(20),
    	CONSTRAINT emp_fk FOREIGN KEY(dept_id) REFERENCES dept(deptno)	-- 外键约束
    );
    ```

  - 方式2-在创建表外设置外键约束
    外键约束也可以在修改表时添加，但是添加外键约束的前提是：从表中外键列中的数据必须与主表中主键列中的数据一致或者是没有数据。
    ![image-20240119144938193](photo/image-20240119144938193.png)实现：

    ```sql
    -- 方式2-在创建表外设置外键约束
    -- 创建部门表
    CREATE TABLE IF NOT EXISTS dept2(
    	deptno VARCHAR(20) PRIMARY KEY,	-- 部门号
    	name VARCHAR(20)	-- 部门名字
    );
    -- 创建员工表
    CREATE TABLE IF NOT EXISTS emp2(
    	eid VARCHAR(20) PRIMARY KEY,	-- 员工编号
    	ename VARCHAR(20),	-- 员工名字
    	age INT,	-- 员工年龄
    	dept_id VARCHAR(20)	-- 员工所属部门
    );
    -- 创建外键约束
    ALTER TABLE emp ADD CONSTRAINT dept_id_fk FOREIGN KEY(dept_id) REFERENCES dept2(deptno);
    ```

  在外键约束下的数据操作：

  1. 数据插入：

     ```sql
     -- 添加主表数据
     -- 注意必须先给主表添加数据
     INSERT INTO dept VALUES('1001','研发部');
     INSERT INTO dept VALUES('1002','销售部');
     INSERT INTO dept VALUES('1003','财务部');
     INSERT INTO dept VALUES('1004','人事部');
     
     -- 添加从表数据
     -- 注意给从表添加数据时，外键列的值不能随便写，必须依赖主表的主键列
     insert into emp values('1','乔峰',20, '1001');
     insert into emp values('2','段誉',21, '1001');
     insert into emp values('3','虚竹',23, '1001');
     insert into emp values('4','阿紫',18, '1002');
     insert into emp values('5','扫地僧',35, '1002');
     insert into emp values('6','李秋水',33, '1003');
     insert into emp values('7','鸠摩智',50, '1003'); 
     insert into emp values('8','天山童姥',60, '1005');  -- 不可以
     ```

  2. 数据删除
     注意：

     1. 主表的数据被从表依赖时，不能删除，否则可以删除
     2. 从表的数据可以随便删除

     ```sql
     -- 删除数据
     /*
     注意：
     1.主表的数据被从表依赖时，不能删除，否则可以删除
     2.从表的数据可以随便删除
     */
     DELETE FROM dept WHERE deptno = '1001';	-- 不可以删除
     DELETE FROM dept WHERE deptno = '1004';	-- 可以删除
     DELETE FROM emp WHERE eid = '7';	-- 可以删除
     ```

  删除外键约束：
  当一个表中不需要外键约束时，就需要从表中将其删除。外键一旦删除，就会解除主表和从表间的关联关系。
  格式：
  ![image-20240119151435311](photo/image-20240119151435311.png)实现：

  ```sql
  ALTER TABLE emp2 DROP FOREIGN KEY dept_id_fk;
  ```

- 多对多关系
  在多对多关系中，A表的一行对应B的多行，B表的一行对应A表的多行，我们要新增加一个中间表，来建立多对多关系。

  ```sql
  -- 4.多对多关系
  
  -- 学生表和课程表（多对多）
  -- 1 创建学合适呢个表student（左侧主表）
  CREATE TABLE IF NOT EXISTS student(
  	sid INT PRIMARY KEY auto_increment,
  	name VARCHAR(20),
  	age INT,
  	gender VARCHAR(20)
  );
  -- 2 创建课程表course（右侧主表）
  CREATE TABLE course(
  	cid INT PRIMARY KEY auto_increment,
  	cidname VARCHAR(20)
  );
  -- 3 创建中间表
  CREATE TABLE score(
  	sid INT,
  	cid INT,
  	score DOUBLE
  );
  -- 4 建立外键约束（2次）
  ALTER TABLE score ADD FOREIGN KEY(sid) REFERENCES student(sid);
  ALTER TABLE score ADD FOREIGN KEY(cid) REFERENCES course(cid);
  -- 5给学生表添加数据
  INSERT INTO student VALUES(1,'小龙女',18,'女'),(2,'阿紫',19,'女'),(3,'周芷若',20,'男');
  -- 6给课程表添加数据
  INSERT INTO course VALUES(1,'语文'),(2,'数学'),(3,'英语');
  -- 7给中间表添加数据
  INSERT INTO score VALUES(1,1,78),(1,2,75),(2,1,88),(2,3,90),(3,2,80),(3,3,65);
  
  -- 修改和删除时，中间从表可以随便删除和修改，但是两边的主表受从表依赖的数据不能删除或者修改
  ```


### 4、多表联合查询

- 介绍
  多表查询就是同时查询两个或两个以上的表，因为有的时候用户在查看数据的时候，需要显示的数据来自多张表。
  多表查询有以下分类：

  - 交叉连接查询【产生笛卡尔积，了解】
  - 内连接查询【使用的关键字inner join – inner可以省略】
  - 外连接查询【使用的关键字outer join – outer可以省略】
  - 子查询
  - 表自关联

- 交叉连接查询

  - 交叉连接查询返回被连接的两个表所有数据行的笛卡尔积
  - 笛卡尔积可以理解为一张表的每一行去和另外一张表的任意一行进行匹配
  - 假如A表有m行数据，B表有n行数据，则返回m*n行数据
  - 笛卡尔积会产生很多冗余的数据，后期的其他查询可以在该集合的基础上进行条件筛选

  格式：
  ![image-20240126200104006](photo/image-20240126200104006.png)操作：

  ```sql
  -- 一、交叉连接查询
  
  SELECT * FROM dept3,emp3;
  ```

- 内连接查询
  内连接查询求多张表的交际
  格式：
  ![image-20240126201434172](photo/image-20240126201434172.png)操作：

  ```sql
  
  ```

  
